---
title: "Homework Assignment #2"
subtitle: "Exploring patterns of environmental justice"
author: "Joshua Mull"
date: last-modified
execute:
  warning: false
  message: false
format:
  html:
    toc: true
    code-fold: true
editor_options: 
  chunk_output_type: console
---

## Part 1: Legacy of redlining in current environmental (in)justice

#### Load Packages and Read Data

```{r}
library(sf)
library(tidyverse)
library(tmap)
library(stars)
library(kableExtra)
library(here)
library(dplyr)
library(tidyr)
```

#### Read in data
```{r}
# Read in data with here
la_red <- st_read(here::here("data", "mapping-inequality", "mapping-inequality-los-angeles.json")) %>% 
  st_make_valid()

# Read in bird biodiversity data
birds <- st_read(here::here("data", "gbif-birds-LA", "gbif-birds-LA.shp"))

# Read in ejscreen data
ejscreen <- st_read(here::here("data", "ejscreen", "EJSCREEN_2023_BG_StatePct_with_AS_CNMI_GU_VI.gdb"))

```

#### Check the coordinate system 
```{r}
# Use st_crs to check coordinate systems 
st_crs(birds) == st_crs(la_red)
st_crs(la_red) == st_crs(ejscreen)
st_crs(ejscreen) == st_crs(birds)
```

#### Transform coordinate system to match 
```{r}
# Transform la_red to match ejscreen coordinate system 
ejscreen <- st_transform(ejscreen, crs = st_crs(la_red))
```

#### Check the coordinate system again 
```{r}
# Use st_crs to check coordinate systems 
st_crs(birds) == st_crs(la_red)
st_crs(la_red) == st_crs(ejscreen)
st_crs(ejscreen) == st_crs(birds)
```

#### Filter ejscreen data counties that make our base map
```{r}
# Use filter to filter data for LA, Orange, and San Bernardino Counties 
los_ang_county <- ejscreen %>%
filter(CNTY_NAME == "Los Angeles County")

orange_county <- ejscreen %>% 
  filter(CNTY_NAME == "Orange County")

san_bern_county <- ejscreen %>% 
  filter(CNTY_NAME == "San Bernardino County")
```

#### Make a map of neighborhoods colored by HOLC grades
```{r}
# Use tmap package to make holc map
holc_map_la <- tm_shape(los_ang_county, bbox = la_red) +
  tm_polygons(col = "white") +
  tm_shape(la_red) + 
  tm_polygons("grade", palette = c("#B3E4FF", "#02B0C0","#FDE996","#FE9F6C"), title = "HOLC Grade") +
  tm_shape(san_bern_county) +
  tm_polygons(col = "white") +
  tm_shape(orange_county) +
  tm_polygons(col = "white") +
  tm_layout(
    title = "HOLC Grades Within LA County",
    title.fontfamily = "serif",
    title.fontface = "bold",
    title.position = c(.61, .95),
    legend.title.size = .9,
    legend.text.size = .4,
    legend.position = c(".05", "05"),
    legend.bg.color = NA,
    legend.bg.alpha = .7,
    bg.color = "white")

print(holc_map_la)
```

#### A table summarizing the percent of current census block groups within each HOLC grade (or none)

```{r, eval}
# Calculate the percent of census block groups within each HOLC grade
summary_holc <- la_red %>%
  group_by(grade) %>%
  summarise(count = n()) %>%
  mutate(percent = round((count / sum(count)) * 100, 2)) %>%
  st_drop_geometry() %>%
  select(-count)

# Create the table with kableExtra
  knitr::kable(summary_holc,
        col.names = c("HOLC Grade", "% of Census Block"),
        format = "markdown",
        caption = "Percentage of Current Census Block Groups Within HOLC Grade")

```

#### A set of figures summarizing current conditions (from the EJScreen data) within HOLC grades using the mean of the following variables:% 
- low income
- percentile for Particulate Matter 2.5
- percentile for low life expectancy

#### Join data. Filter data for making a table and graph
```{r}
# Spatial join data 
joined_data <- st_join(los_ang_county, la_red, join = st_within)

# Filter, Select and summarize columns for mean. Group by grade
holc_mean_filter <- joined_data %>% 
  filter(!is.na(grade)) %>%
  select(LOWINCPCT, D5_PM25, LIFEEXPPCT, grade) %>%
  group_by(grade) %>% 
  summarise(across(c(LOWINCPCT, D5_PM25, LIFEEXPPCT), 
                   list(mean = ~ round(mean(.x, na.rm = TRUE), 2)),
                        .names = "mean_{col}")) %>%
  mutate(mean_LOWINCPCT = mean_LOWINCPCT * 100) %>%
  mutate(mean_LIFEEXPPCT = mean_LIFEEXPPCT * 100) %>% 
  st_drop_geometry()
```

#### Make data long and plot it with geom_bar
```{r}
# Gather data into long format
long_data_holc_mean <- holc_mean_filter %>%
  pivot_longer(cols = c(mean_LOWINCPCT, mean_D5_PM25, mean_LIFEEXPPCT), names_to = "variable", values_to = "value")

# Create the bar graph
holc_map_mean <- ggplot(long_data_holc_mean, aes(x = grade, y = value, fill = variable)) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_manual(
    values = c("mean_D5_PM25" = "#388697", "mean_LOWINCPCT" = "#08415C", "mean_LIFEEXPPCT" = "#B5FFE1"),
    labels = c("mean_D5_PM25" = "Mean Percent PM 2.5", "mean_LIFEEXPPCT" = "Mean Percent Low Life Expectency", "mean_LOWINCPCT" = "Mean % Low Income")) +
  labs(title = "Environmental and Social Conditions Across HOLC Grades", x = "Grade", y = "Percentage") +
  theme_minimal() + 
  theme(legend.title = element_blank())

# Print
print(holc_map_mean)
```

#### Create table of mean values with kable
```{r}
# Create mean table with kableExtra
  kable(holc_mean_filter,
        caption = "Environmental and Social Conditions Across HOLC Grades",
        col.names = c("Grade", "Mean % Low Income", "Mean Percent PM25", "Mean Percent Low Life Expectency"),
        format = "markdown")  

```

#### A paragraph reflecting on these results

The table shows each Grades A-D, a rating system ranked from best to poorest based on their perceived safety for real estate investment. The table shows a clear connection between the three means we selected. As the grade decreases from A to D, the mean percentage of low income, percentile of PM 2.5, percent of the population with a low life expectancy all go up. This shows that neighborhoods in the D sections, almost always occupied by minorities, suffered in all of these categories due to redlining. 

## Part 2: Legacy of redlining in biodiversity observations

```{r}

```

